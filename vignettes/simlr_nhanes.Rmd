---
title: "simlr: nhanes application explained"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{simlr: nhanes application explained}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


## Introduction

We extract distinct but related types of data from the [NHANES](https://wwwn.cdc.gov/nchs/nhanes/Default.aspx).  The data types are:

* demographics: age, sex, educational attainment;

* diet: measurements of nutritional status;

* physical: blood pressure and physical measurements;

* mental health: outcomes from Patient Health Questionnaire-9;

* environmental exposures: metals and related environmental toxins.

These are combined into SiMLR for an unsupervised dimensionality reduction.  The resulting low-dimensional representations are used for joint prediction of cognitive outcomes.  Over 2000 subjects with these measurements are available along with environmental exposures in a large majority of these ($>$ 1400).

We predict the variable `z_digit_re` in NHANES which refers to the Digit Symbol Substitution Test (DSST), a cognitive assessment tool. The DSST evaluates processing speed, sustained attention, and working memory by requiring participants to match symbols with corresponding numbers under time constraints.

In summary, SiMLR identifies predictors from diet, physical measurements, environmental exposures and mental health that jointly relate to DSST and related variables.  This example builds on prior work such as [this](https://pmc.ncbi.nlm.nih.gov/articles/PMC10093810/) and [this](https://www.nature.com/articles/s41598-025-87384-y) and [many others](https://scholar.google.com/scholar?hl=en&as_sdt=0%2C33&q=NHANES+cognition+exposures+diet+&btnG=).

## Setup 

Load the relevant libraries.

```{r setup}
# Load necessary libraries
library(ggplot2)
library(ggfortify)
library(gridExtra)
library(ellipse)
library(ANTsR)
library(subtyper)
library( nhanesA )
library( simlr.nhanes )
library( dplyr )
library(htmlwidgets)
data("nhanescog_2011_2014")
data("nhanes_dict")



```


## NHANES example

We download these data on the fly and merge them together using the embedded data as well as the `nhanesA` package.

```{r nhanes,cache=FALSE,echo=FALSE}
#
# Demographic data (e.g., 2011-2012 cycle)
#
demo_data <- nhanes('DEMO_G')
cog_data <- nhanes('CFQ_G')
depression_data <- nhanes('DPQ_G')
sleep_data <- nhanes('SLQ_G')
bp = nhanes( "BPX_G")
bm = nhanes( "BMX_G")
env_data <- nhanes('PBCD_G')  # Example for phthalates and blood metals

# Demographic data (e.g., 2013-2014 cycle)
demo_data13 <- nhanes('DEMO_H')
cog_data13<- nhanes('CFQ_H')
depression_data13 <- nhanes('DPQ_H')
sleep_data13 <- nhanes('SLQ_H')
bp13 = nhanes( "BPX_H")
bm13 = nhanes( "BMX_H")
env_data13 <- nhanes('PBCD_H')  # Example for phthalates and blood metals


phdata <- nhanes('PHTHTE_G')  # Example for phthalates and blood metals
phdata13 <- nhanes('PHTHTE_H')  # Example for phthalates and blood metals
# pfasd <- nhanes('SSPFAS_G')  # Example for phthalates and blood metals
# pfasd13 <- nhanes('SSPFAS_H')  # Example for phthalates and blood metals
vocd <- nhanes('VOCWB_G')  # Example for phthalates and blood metals
vocd13 <- nhanes('VOCWB_H')  # Example for phthalates and blood metals
hvmt <- nhanes('UAS_G')  # Example for phthalates and blood metals
hvmt13 <- nhanes('UAS_H')  # Example for phthalates and blood metals
pst <- nhanes('PSTPOL_G')  # Example for phthalates and blood metals
pst13 <- nhanes('PSTPOL_H')  # Example for phthalates and blood metals
pfc <- nhanes('PFC_G')  # Example for phthalates and blood metals
pfc13 <- nhanes('PFC_H')  # Example for phthalates and blood metals
mm <- nhanes('UHM_G')  # Example for phthalates and blood metals
mm13 <- nhanes('UHM_H')  # Example for phthalates and blood metals
cu <- nhanes('CUSEZN_G')  # Example for phthalates and blood metals
cu13 <- nhanes('CUSEZN_H')  # Example for phthalates and blood metals
ig <- nhanes('IHgEM_G')  # Example for phthalates and blood metals
ig13 <- nhanes('IHgEM_H')  # Example for phthalates and blood metals
uh <- nhanes('UHG_G')  # Example for phthalates and blood metals
uh13 <- nhanes('UHG_H')  # Example for phthalates and blood metals

# check UH, IH, CU, PF, PS, UA, VOC, PH, BD, BM

di <- nhanes('DR1TOT_G')  # diet
di13 <- nhanes('DR1TOT_H')  # diet

merge_nhanes_data <- function( joinid, nacol,  ...) {
  datasets <- list(...)
  dfout <- Reduce(function(x, y) {
    left_join(x, y, by = joinid)  # Adjust "ID" to your common column name
  }, datasets)
  dfout = dfout[ !is.na( dfout[,nacol] ), ]
  return( dfout )
}

merged_data <- merge_nhanes_data( 'SEQN', 'CFDDS',
  merge_same_type_columns(cog_data, cog_data13),
  merge_same_type_columns(demo_data,demo_data13),
  merge_same_type_columns(di,di13),
  merge_same_type_columns(depression_data,depression_data13),
  merge_same_type_columns(sleep_data,sleep_data13),
  merge_same_type_columns(bp,bp13),
  merge_same_type_columns(bm,bm13),
  merge_same_type_columns(env_data, env_data13),
  merge_same_type_columns(phdata, phdata13),
  merge_same_type_columns(vocd, vocd13),
  merge_same_type_columns(cu, cu13),
  merge_same_type_columns(ig, ig13),
  merge_same_type_columns(uh, uh13),
  mm,
#  merge_same_type_columns(pst, pst13) )
#  merge_same_type_columns(pfc, pfc13) ,
  merge_same_type_columns(hvmt, hvmt13))

table(merged_data$RIAGENDR)
nhanescog$SEQN = nhanescog$seqn
merged_data=merge(nhanescog, merged_data, by='SEQN')

missvec=colSums(is.na(merged_data)) / nrow( merged_data )
hist( missvec, main='histogram of % NA')


depnames = c( 
  getNamesFromDataframe( "SLQ", merged_data ),
#  getNamesFromDataframe( "DPQ", merged_data, exclusions='DPQ100' )
  getNamesFromDataframe( "DPQ", merged_data )
)
for ( x in depnames ) merged_data[,x]=map_freq_to_numeric(merged_data,x) 

idata = impute_data(merged_data)
idata = idata[ idata$BPXDI1 > 20 & idata$BPXDI2 > 20 & idata$BPXDI3 > 20 & idata$BPXDI4 > 20,  ]
fdata <- filter_na_columns(merged_data, max_na_percent = 0.85)  # Removes columns with >10% NAs
missvec=colSums(is.na(fdata)) / nrow( fdata )
hist( missvec, main='histogram of % NA')
fdata = fdata[ na2f(fdata$BPXDI1 > 20 & fdata$BPXDI2 > 20 & fdata$BPXDI3 > 20 ),  ]
fdata$race = factor( fdata$race )
fdata$riagendr = factor( fdata$riagendr )

myformR =  create_formula( fdata, 'z_digit_re', c('SEQN', 'RIDAGEMN','RIDRETH3', 'CFASTAT', 'CFDCRNC', 'CFDCIT', 'CFDCST', 'CFDAPP', 'CFDAST', 'CFALANG', 'BPAARM', 'CFDCCS', 'CFDCST', 'CFDCIT', 'CFDCSR', 'CFDCIR', 'CFDCST', 'CFDCIT', 'CFDARNC', 'CFDDS',
'INDHHIN2','DMDHRBR4','INDFMIN2','PEASCST1','PEASCCT1','PEASCTM1',
# 'BPACSZ','BPXML1','URXMBP','URXMC1','URDUMMAL','SLD010H','LBXBMN','URXCNP','URXECP','URXMHH','URXMHP','URXMHNC','LBXV06','LBXV2A','LBXV3B','LBXV4C','LBXVCB','LBXVEB','LBXVCB','LBXVIPB','LBXVMC','LBXVOX','LBXVTC','LBXVTE','LBXVXY','URXUAS5','URXUAB','URXUAC','URXUMMA','URXUAS3','LBXBSE', 'RIAGENDR', 'RIDAGEYR', 'RIDRETH1', 'seqn',
'age_cat','ridreth1','ridreth3','edu_cat','cfastat','year','female','cerad_sum',
# 'wtint2yr','wtmec2yr',
'BMXARML','BMXARMC','BMXHT','BMXLEG','BMXWAIST',
'INDFMPIR', 'DRABF',
getNamesFromDataframe( 'DRQS',fdata),
getNamesFromDataframe( 'DPD',fdata),
getNamesFromDataframe( 'cfd',fdata),
getNamesFromDataframe( 'z_',fdata),
getNamesFromDataframe( 'low_',fdata),
getNamesFromDataframe( 'sdm',fdata),
# getNamesFromDataframe( 'DPQ',depression_data, exclusions=c('DPQ080','DPQ030''DPQ080',)),
# getNamesFromDataframe( 'DPQ',depression_data, exclusions=c('DPQ100')),
# getNamesFromDataframe( 'URXUCR',fdata ),
# getNamesFromDataframe( 'BMXSAD',fdata ),
# getNamesFromDataframe( 'BPAEN',fdata ),
# getNamesFromDataframe( 'BPXP',fdata ),
getNamesFromDataframe( 'DMD',fdata ),
getNamesFromDataframe( 'DMDHHSZ',fdata ),
getNamesFromDataframe( 'DRD',fdata ),
getNamesFromDataframe( 'DBD',fdata ),
#getNamesFromDataframe( 'DR1',fdata ),
getNamesFromDataframe( 'WT',fdata ),
getNamesFromDataframe( 'SDM',fdata ),
getNamesFromDataframe( 'DMQ',fdata ),
getNamesFromDataframe( 'FIA',fdata ),
getNamesFromDataframe( 'MIA',fdata ),
getNamesFromDataframe( 'AIA',fdata ),
getNamesFromDataframe( 'DMDCIT',fdata ),
getNamesFromDataframe( 'DMDYRS',fdata ),
getNamesFromDataframe( 'RIDE',fdata ),
getNamesFromDataframe( 'CFDCST',fdata ),
getNamesFromDataframe( 'SDDSRVY', fdata ),
getNamesFromDataframe( 'CFDCIT',fdata ), getNamesFromDataframe( 'LC',fdata ), getNamesFromDataframe( 'SI',fdata ) ) )
problematic_factors <- check_formula_factors(myformR, df)
print(problematic_factors)
idata2=impute_data(fdata )
# mdl = lm( myformR, data=idata2)
# summary( mdl )
# mdl0 = lm( myformR, data=fdata)
# summary( mdl0 )
##############
####
```


Define the categories of data so that these can be used to identify a low-dimensional representation based on the SiMLR objective.  We do not use the cognitive data with which this embedding will be associated later.

```{r simlrcats0,eval=TRUE,echo=TRUE}
####################################
if ( TRUE ) {
  fdatanum = convert_to_numeric_matrix( fdata )
  tarcols = colnames(fdatanum)
  grepper =multigrep( c("_NA","limit"),tarcols) 
  fdatanum = fdatanum[ , -grepper]
  tarcols=tarcols[-grepper]
  fdatanum = data.frame( (fdatanum))
  colnames(fdatanum)=tarcols
}
```

```{r simlrcats1,eval=TRUE,echo=TRUE}
colcats=rep("Basic",ncol(fdatanum))
colcats[ colnames(fdatanum) %in%  c("ridageyr",
  getNamesFromDataframe("riagendr",fdatanum),
  getNamesFromDataframe("race",fdatanum),
  "dmdeduc2","INDFMPIR") ]='demog'
```

```{r simlrcats2,eval=TRUE,echo=TRUE}
bpname=getNamesFromDataframe( "BPX",fdatanum)
bmname=getNamesFromDataframe( "BMX",fdatanum)
colcats[ colnames(fdatanum) %in%  c(bmname,bpname,"Testosterone","TotChol","Diabetes" ) ]='physical'
colcats[ colnames(fdatanum) %in%   c(
  getNamesFromDataframe( "DPQ", fdatanum ), 
  getNamesFromDataframe( "SLQ", fdatanum ) )  ]='mentalhealth'
x=c('LC','.x','.y','URDUMMAL','LBXVDE','LBX4CE')
colcats[ colnames(fdatanum) %in%  getNamesFromDataframe( "LBX", fdatanum, exclusions=x ) ]='exposures'
colcats[ colnames(fdatanum) %in%  getNamesFromDataframe( "LBD", fdatanum, exclusions=x ) ]='exposures'
colcats[ colnames(fdatanum) %in%  getNamesFromDataframe( "URX", fdatanum, exclusions=x ) ]='exposures'
colcats[ colnames(fdatanum) %in%  getNamesFromDataframe( "URD", fdatanum, exclusions=x ) ]='exposures'
colcats[ colnames(fdatanum) %in%  getNamesFromDataframe( "LBC", fdatanum, exclusions=x ) ]='exposures'
colcats[ colnames(fdatanum) %in%  getNamesFromDataframe( "DR1T", fdatanum, exclusions='DR1TWS' ) ]='diet'
# colcats[ colnames(fdatanum) %in%  getNamesFromDataframe( "cfd", fdatanum )[-1] ]='digitspan'
tbl=table(colcats)
for ( nm in names(tbl)) {
  expmiss=colSums(is.na(fdatanum[ ,colcats == nm ]) )
  colcats[ colnames(fdatanum) %in% names(expmiss)[ expmiss > 800 ]  ] = 'Basic'
  }
tbl=table(colcats)
```


```{r simlrcats3,eval=TRUE,echo=TRUE}
##############
nh_list=list()
knm=names(tbl)[-c(1)]
mycc = complete.cases( fdatanum[ , colcats %in% 'demog' ])
# mycc = !is.na(fdata$LBXTHG) # complete.cases( fdatanum[ , colcats %in% 'exposures' ])
table(mycc)
doimp=TRUE
for ( k in knm ) {
    print(k)
    temp0=(fdatanum[mycc,colcats==k])
    temp = data.frame(convert_to_numeric_matrix( temp0 ))
    vv=apply( temp, 2, FUN=var, na.rm=T )
    temp = temp[ , vv > 0 ]
    if ( k %in% c('exposures','diet') | TRUE ) {
      nn = colnames(temp)
      for (  jj in 1:ncol(temp) ) { # temp = truncatehi(temp, nn[jj], t = 50, removeit = FALSE)
        temp[ , nn[jj] ] = sqrt(temp[ , nn[jj] ]-min(temp[ , nn[jj] ],na.rm=T))
        }
      colnames(temp) = nn
      temp = remove_perfectly_correlated( data.frame( temp ), tolerance=0.01 )
      vv=apply( temp, 2, FUN=var, na.rm=T )
      temp = temp[ , vv > 0 ]
    }
    for ( j in 1:ncol(temp) ) {
#        hist( temp[,j], main=colnames(temp)[j])
#        Sys.sleep(1)
        }
    nh_list[[length(nh_list)+1]]=data.matrix( ( temp ) )
    print(colnames(nh_list[[length(nh_list)]]))
#    nh_list[[length(nh_list)]]=impute_and_report_na(nh_list[[length(nh_list)]] )
    }
names(nh_list)=knm
#####

```

Run the methods using reasonable defaults as recommended by prior work.

```{r nhanessimlrrun,eval=TRUE}
################################################################################
# regs <- regularizeSimlr(nh_list,fraction=0.15,sigma=rep(1.0,length(nh_list)))
#
regs=list()
wdemog=which( knm == 'demog')
for ( wdemog in 1:length(nh_list) ) {
  nh_list[[wdemog]]=antsrimpute( nh_list[[wdemog]] )
  regs[[ wdemog]]=diag( ncol(nh_list[[wdemog]]))
}
regs = regularizeSimlr(nh_list)
for ( wdemog in 1:length(regs) ) {
  plot( image( regs[[wdemog]] ) )
}
names( regs ) = names(nh_list)
# initu=initializeSimlr( nh_list, k=round(max_columns_list(nh_list)), jointReduction=TRUE )
initu=initializeSimlr( nh_list, k=round(max_columns_list(nh_list)*0.8), jointReduction=TRUE )
########################### ########################### 
if ( ! exists("resultNH") ) {
  mysigns = rep("positive",length(nh_list))
  mysigns[ (knm) %in% c('exposures','diet') ]='either'
  params = list( list() )
  params[[1]][[1]] = c('cca','pca')
  params[[1]][[2]] = c('centerAndScale','np')
  params[[2]]=list()
  params[[2]][[1]] = c('regression','ica')
  params[[2]][[2]] = c('whiten','np')
  pindex = 2
  resultNH <- simlr( nh_list, 
        iterations=100,
        sparsenessQuantiles=rep(0.5,length(nh_list)),
        positivities=mysigns, 
        energyType=params[[pindex]][[1]][1], mixAlg=params[[pindex]][[1]][2],
        scale=params[[pindex]][[2]],
        constraint="Stiefelx10x10",
        randomSeed=99,
        initialUMatrix=initu, verbose=T )
  }
#####################################################
#                                          #
#                     #                    #
#                                          #
#####################################################
#                                          #
#                                          #
#####################################################
```

Apply the learned representations to the data matrices.

```{r nhanessimlrstat0,eval=TRUE,fig.width=10,fig.height=8}
# drwwrd
projlist=list()
mysimk=ncol(initu)
for ( k in 1:length(nh_list)) rownames(resultNH$v[[k]])=colnames(nh_list[[k]])
simdf2=data.frame(fdatanum)
simdf2=apply_simlr_matrices( simdf2, resultNH$v, n_limit=ncol(initu), robust=FALSE, center=TRUE, 
  scale=TRUE, absolute_value=mysigns=='positive', verbose=FALSE )
newnames=simdf2[[2]]
simdf2=simdf2[[1]]
cognames = c(
  "z_cerad_re", "z_animal_re",      "z_delayed_re",    "z_global_re",     "z_digit_re"
#  "z_cerad_age", "z_animal_age",     "z_digit_age",      "z_delayed_age",    "z_global_age",
#  "z_cerad_edu", "z_animal_edu",     "z_digit_edu",      "z_delayed_edu",    "z_global_edu"
)
# cognames=c("cerad_sum","cfdast","cfdds")
```

```{r nhanessimlrstatimp,eval=TRUE,fig.width=10,fig.height=8}
dnames = c( "riagendr", "ridageyr", "race", "dmdeduc2", "INDFMPIR",'wtint2yr','wtmec2yr')
simdf2 = data.frame(simdf2)
simdf2[,dnames]=fdata[,dnames]
simdf2[,cognames]=fdata[,cognames]
sep='PC'
tocomp = c("dietPC1","mentalhealthPC1",'physicalPC1')
mycc2 = complete.cases( simdf2[,tocomp]  )
simdf2=simdf2[mycc2,]
simdf2[,newnames]=scale(simdf2[,newnames],T,T)
for ( n in 'exposures' ) {
    for ( v in 1:mysimk ) {
      thiscol=paste0(n,sep,v)
      if ( any( is.na( simdf2[,thiscol] ) )) {
#        simdf2 = simlr_impute( data.frame(simdf2), knm, v, n, separator=sep )
#        simdf2[,thiscol]=antsrimpute(simdf2[,thiscol])
      }
    }
  }
thesena=is.na(simdf2)
nn=colnames(simdf2)
# simdf2 = data.frame( robustMatrixTransform(simdf2))
colnames(simdf2)=nn
simdf2[thesena]=NA
##################################
```

```{r nhanessimlrstatlm,eval=TRUE,fig.width=10,fig.height=8}
# Function to search NHANES variable descriptions
search_nhanes_var <- function(var_name_in, dtname) {  
  # Search for the variable name (case insensitive)
  var_name_in=gsub( "DR1T" ,  "DRXT" , var_name_in)
  result <- unique(subset(nhanes_dict, grepl(var_name_in, nhanes_dict$variable_codename_use, ignore.case = TRUE))$variable_description_use)
  # Return the first match if available
  if (length(result) > 0) {
    return(result[1])
  } else {
    return("Variable not found.")
  }
}

covars=" ~ riagendr + ridageyr + dmdeduc2  +" # race adjusted scores
covars=" ~ 1 +" # race adjusted scores
covars=" ~ riagendr + ridageyr  + dmdeduc2 + INDFMPIR + "
basep=1e-4
# rooter
if ( ! exists("cogind" ) ) cogind = length(cognames)
#############################
pnames=knm[-1]
nsig=0
for ( kk in 1:ncol(initu)) {
  bform = paste0( cognames[cogind], covars, "1" )
  myform = paste0( cognames[cogind], covars,paste0( paste0(pnames,sep,kk), collapse='+'))
  tempdf = simdf2
  for ( qq in knm ) {
    tt=paste0(qq,sep,kk)
    tempdf[ , tt]=psych::winsor( sqrt(tempdf[ , tt] - min(tempdf[ , tt],na.rm=T)), 0.005 )
  }
  mdl = lm( myform, data=tempdf )
  bmdl = lm( bform, data=tempdf[names(predict(mdl)),] )
#  if (doimp) mdl = lm( myform, data=tempdf, weights=tempdf$wtint2yr ) else mdl = lm( myform, data=tempdf, weights=tempdf$wtint2yr  )
  myanv = anova( bmdl, mdl )
  if ( myanv$Pr[2] < basep/mysimk ) {
    cat("*** result begin ***********************************\n")
    print("individual coefficients")
    tailcoffs = tail( coefficients( summary( mdl ) ), 4 )
    print( tailcoffs )
    print( paste("multivar-ANOVA p-value", insight::format_p(myanv$Pr[2],digits=4) ) )
    print( cognames[cogind])
    gglist=list()
    simpreds = c()
    simwts = c()
    for ( k in pnames ) {
      print( paste("Simlr weights", k ) )
      ivec = interpret_simlr_vector2( resultNH$v[[k]], kk, n2show=3, shortnames=F )
      interpname = shorten_names( c( 
        search_nhanes_var( names(ivec)[1] ),
        search_nhanes_var( names(ivec)[2] ) ) )
      names(ivec)[1:2]=interpname
      print( ivec )
      simpreds = c( simpreds, interpname )
      simwts = c( simwts, ivec[1:2] * (tailcoffs[paste0(k,sep,kk),"t value"] ))
      ttl = paste0(k,kk, " ", insight::format_p(tailcoffs[paste0(k,sep,kk),"Pr(>|t|)"],digits=4)  )
      gglist[[length(gglist)+1]]=visreg::visreg(mdl, paste0(k,sep,kk), gg=TRUE ) + ggtitle(ttl) + theme_minimal()
      }
    print( plot_regression_graph( simpreds, simwts, cognames[cogind], method = "alluvial") )
#    sankey <- plot_regression_graph(simpreds, simwts, cognames[cogind], method = "sankey")
#    saveWidget(sankey, "sankey_plot.html", selfcontained = TRUE)
#    htmltools::includeHTML("sankey_plot.html")
    ( grid.arrange( grobs=gglist, nrow=2 ) )
    nsig=nsig+1
    cat("*** result end ***********************************\n\n")
#    Sys.sleep(3)
  }
}
print(nsig)
##########################################################################################
##########################################################################################
# https://wwwn.cdc.gov/nchs/nhanes/search/default.aspx
# > interpret_simlr_vector2( resultNH$v[['exposures']], 1, n2show=5, shortnames=F )
#   LBXVBZ    LBXVOX    LBXVFN    LBX2DF 
# benzene, Xylene, furan, Dimethylfuran
# 1.0000000 0.3346728 0.1868323 0.0586727 
##########################################################################################
```



```{r hold,echo=FALSE,eval=FALSE}
for ( kk in 1:length(cognames)) {
    myform = paste0( cognames[kk], covars,paste0( colnames(simdf), collapse='+'))
    tempdf = simdf2[mycc,]
    mdl = lm( myform, data=tempdf )
  #  if (doimp) mdl = lm( myform, data=tempdf, weights=tempdf$wtint2yr ) else mdl = lm( myform, data=tempdf, weights=tempdf$wtint2yr  )
    print( summary( mdl ) )
    print( cognames[kk])
    Sys.sleep(3)
  }
```