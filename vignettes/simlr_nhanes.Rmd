---
title: "simlr: nhanes application explained"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{simlr: nhanes application explained}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


## Introduction

We extract distinct but related types of data from the [NHANES](https://wwwn.cdc.gov/nchs/nhanes/Default.aspx).  The data types are:

* demographics: age, sex, educational attainment;

* diet: measurements of nutritional status;

* physical: blood pressure and physical measurements;

* mental health: outcomes from Patient Health Questionnaire-9;

* environmental exposures: metals and related environmental toxins.

These are combined into SiMLR for an unsupervised dimensionality reduction.  The resulting low-dimensional representations are used for joint prediction of cognitive outcomes.  Over 400 subjects with these measurements are available along with environmental exposures.

## Setup 

Load the relevant librarys.

```{r setup}
# Load necessary libraries
library(ggplot2)
library(ggfortify)
library(ellipse)
library(ANTsR)
library(subtyper)
library( nhanesA )
library( simlr.nhanes )
library( dplyr )
data("nhanescog_2011_2014")
```


## NHANES example

We download these data on the fly and merge them together using the embedded data as well as the `nhanesA` package.

```{r nhanes,cache=TRUE,echo=FALSE}
# Demographic data (e.g., 2011-2012 cycle)
demo_data <- nhanes('DEMO_G')
cog_data <- nhanes('CFQ_G')
depression_data <- nhanes('DPQ_G')
sleep_data <- nhanes('SLQ_G')
bp = nhanes( "BPX_G")
bm = nhanes( "BMX_G")
env_data <- nhanes('PBCD_G')  # Example for phthalates and blood metals

# Demographic data (e.g., 2013-2014 cycle)
demo_data13 <- nhanes('DEMO_H')
cog_data13<- nhanes('CFQ_H')
depression_data13 <- nhanes('DPQ_H')
sleep_data13 <- nhanes('SLQ_H')
bp13 = nhanes( "BPX_H")
bm13 = nhanes( "BMX_H")
env_data13 <- nhanes('PBCD_H')  # Example for phthalates and blood metals


phdata <- nhanes('PHTHTE_G')  # Example for phthalates and blood metals
phdata13 <- nhanes('PHTHTE_H')  # Example for phthalates and blood metals
# pfasd <- nhanes('SSPFAS_G')  # Example for phthalates and blood metals
# pfasd13 <- nhanes('SSPFAS_H')  # Example for phthalates and blood metals
vocd <- nhanes('VOCWB_G')  # Example for phthalates and blood metals
vocd13 <- nhanes('VOCWB_H')  # Example for phthalates and blood metals
hvmt <- nhanes('UAS_G')  # Example for phthalates and blood metals
hvmt13 <- nhanes('UAS_H')  # Example for phthalates and blood metals
pst <- nhanes('PSTPOL_G')  # Example for phthalates and blood metals
pst13 <- nhanes('PSTPOL_H')  # Example for phthalates and blood metals
pfc <- nhanes('PFC_G')  # Example for phthalates and blood metals
pfc13 <- nhanes('PFC_H')  # Example for phthalates and blood metals
mm <- nhanes('UHM_G')  # Example for phthalates and blood metals
mm13 <- nhanes('UHM_H')  # Example for phthalates and blood metals
cu <- nhanes('CUSEZN_G')  # Example for phthalates and blood metals
cu13 <- nhanes('CUSEZN_H')  # Example for phthalates and blood metals
ig <- nhanes('IHgEM_G')  # Example for phthalates and blood metals
ig13 <- nhanes('IHgEM_H')  # Example for phthalates and blood metals
uh <- nhanes('UHG_G')  # Example for phthalates and blood metals
uh13 <- nhanes('UHG_H')  # Example for phthalates and blood metals

di <- nhanes('DR1TOT_G')  # diet
di13 <- nhanes('DR1TOT_H')  # diet


merge_nhanes_data <- function( joinid, nacol,  ...) {
  datasets <- list(...)
  dfout <- Reduce(function(x, y) {
    left_join(x, y, by = joinid)  # Adjust "ID" to your common column name
  }, datasets)
  dfout = dfout[ !is.na( dfout[,nacol] ), ]
  return( dfout )
}

merged_data <- merge_nhanes_data( 'SEQN', 'CFDDS',
  merge_same_type_columns(cog_data, cog_data13),
  merge_same_type_columns(demo_data,demo_data13),
  merge_same_type_columns(di,di13),
  merge_same_type_columns(depression_data,depression_data13),
  merge_same_type_columns(sleep_data,sleep_data13),
  merge_same_type_columns(bp,bp13),
  merge_same_type_columns(bm,bm13),
  merge_same_type_columns(env_data, env_data13),
  merge_same_type_columns(phdata, phdata13),
  merge_same_type_columns(vocd, vocd13),
  merge_same_type_columns(cu, cu13),
  merge_same_type_columns(ig, ig13),
  merge_same_type_columns(uh, uh13),
  mm,
#  merge_same_type_columns(pst, pst13) )
#  merge_same_type_columns(pfc, pfc13) ,
  merge_same_type_columns(hvmt, hvmt13))

table(merged_data$RIAGENDR)
nhanescog$SEQN = nhanescog$seqn
merged_data=merge(nhanescog, merged_data, by='SEQN')


depnames = c( 
  getNamesFromDataframe( "SLQ", merged_data ),
#  getNamesFromDataframe( "DPQ", merged_data, exclusions='DPQ100' )
  getNamesFromDataframe( "DPQ", merged_data )
)
for ( x in depnames ) merged_data[,x]=map_freq_to_numeric(merged_data,x) 

idata = impute_data(merged_data)
idata = idata[ idata$BPXDI1 > 20 & idata$BPXDI2 > 20 & idata$BPXDI3 > 20 & idata$BPXDI4 > 20,  ]
fdata <- filter_na_columns(merged_data, max_na_percent = 0.85)  # Removes columns with >10% NAs
fdata = fdata[ na2f(fdata$BPXDI1 > 20 & fdata$BPXDI2 > 20 & fdata$BPXDI3 > 20 ),  ]
fdata$race = factor( fdata$race )
fdata$riagendr = factor( fdata$riagendr )

myformR =  create_formula( fdata, 'z_digit_re', c('SEQN', 'RIDAGEMN','RIDRETH3', 'CFASTAT', 'CFDCRNC', 'CFDCIT', 'CFDCST', 'CFDAPP', 'CFDAST', 'CFALANG', 'BPAARM', 'CFDCCS', 'CFDCST', 'CFDCIT', 'CFDCSR', 'CFDCIR', 'CFDCST', 'CFDCIT', 'CFDARNC', 'CFDDS',
'INDHHIN2','DMDHRBR4','INDFMIN2','PEASCST1','PEASCCT1','PEASCTM1','BPACSZ','BPXML1','URXMBP','URXMC1','URDUMMAL','SLD010H','LBXBMN','URXCNP','URXECP','URXMHH','URXMHP','URXMHNC','LBXV06','LBXV2A','LBXV3B','LBXV4C','LBXVCB','LBXVEB','LBXVCB','LBXVIPB','LBXVMC','LBXVOX','LBXVTC','LBXVTE','LBXVXY','URXUAS5','URXUAB','URXUAC','URXUMMA','URXUAS3','LBXBSE', 'RIAGENDR', 'RIDAGEYR', 'RIDRETH1', 'seqn',
'age_cat','ridreth1','ridreth3','edu_cat','cfastat','year','female','cerad_sum',
# 'wtint2yr','wtmec2yr',
'BMXARML','BMXARMC','BMXHT','BMXLEG','BMXWAIST',
'INDFMPIR', 'DRABF',
getNamesFromDataframe( 'DRQS',fdata),
getNamesFromDataframe( 'DPD',fdata),
getNamesFromDataframe( 'cfd',fdata),
getNamesFromDataframe( 'z_',fdata),
getNamesFromDataframe( 'low_',fdata),
getNamesFromDataframe( 'sdm',fdata),
# getNamesFromDataframe( 'DPQ',depression_data, exclusions=c('DPQ080','DPQ030''DPQ080',)),
# getNamesFromDataframe( 'DPQ',depression_data, exclusions=c('DPQ100')),
getNamesFromDataframe( 'URXUCR',fdata ),
getNamesFromDataframe( 'BMXSAD',fdata ),
getNamesFromDataframe( 'BPAEN',fdata ),
getNamesFromDataframe( 'BPXP',fdata ),
getNamesFromDataframe( 'DMD',fdata ),
getNamesFromDataframe( 'DMDHHSZ',fdata ),
getNamesFromDataframe( 'DRD',fdata ),
getNamesFromDataframe( 'DBD',fdata ),
#getNamesFromDataframe( 'DR1',fdata ),
getNamesFromDataframe( 'WT',fdata ),
getNamesFromDataframe( 'SDM',fdata ),
getNamesFromDataframe( 'DMQ',fdata ),
getNamesFromDataframe( 'FIA',fdata ),
getNamesFromDataframe( 'MIA',fdata ),
getNamesFromDataframe( 'AIA',fdata ),
getNamesFromDataframe( 'DMDCIT',fdata ),
getNamesFromDataframe( 'DMDYRS',fdata ),
getNamesFromDataframe( 'RIDE',fdata ),
getNamesFromDataframe( 'CFDCST',fdata ),
getNamesFromDataframe( 'SDDSRVY', fdata ),
getNamesFromDataframe( 'CFDCIT',fdata ), getNamesFromDataframe( 'LC',fdata ), getNamesFromDataframe( 'SI',fdata ) ) )
problematic_factors <- check_formula_factors(myformR, df)
print(problematic_factors)
idata2=impute_data(fdata )
# mdl = lm( myformR, data=idata2)
# summary( mdl )
# mdl0 = lm( myformR, data=fdata)
# summary( mdl0 )
##############
####
```


Define the categories of data so that these can be used to identify a low-dimensional representation based on the SiMLR objective.

```{r simlrcats,eval=TRUE,echo=TRUE}
####################################
colcats=rep("Basic",ncol(fdata))
colcats[ colnames(fdata) %in%  c("ridageyr","riagendr","race","dmdeduc2","INDFMPIR") ]='demog'
bpname=getNamesFromDataframe( "BPX",fdata)
bmname=getNamesFromDataframe( "BMX",fdata)
colcats[ colnames(fdata) %in%  c(bmname,bpname,"Testosterone","TotChol","Diabetes" ) ]='physical'
colcats[ colnames(fdata) %in%   c(
  getNamesFromDataframe( "DPQ", fdata ), 
  getNamesFromDataframe( "SLQ", fdata ) )  ]='mentalhealth'
x=c('LC','.x','.y','URDUMMAL','LBXVDE','LBX4CE')
colcats[ colnames(fdata) %in%  getNamesFromDataframe( "LBX", fdata, exclusions=x ) ]='exposures'
colcats[ colnames(fdata) %in%  getNamesFromDataframe( "LBD", fdata, exclusions=x ) ]='exposures'
#colcats[ colnames(fdata) %in%  getNamesFromDataframe( "URX", fdata, exclusions=x ) ]='exposures'
# colcats[ colnames(fdata) %in%  getNamesFromDataframe( "URD", fdata, exclusions=x ) ]='exposures'
# colcats[ colnames(fdata) %in%  getNamesFromDataframe( "LBC", fdata, exclusions=x ) ]='exposures'
colcats[ colnames(fdata) %in%  getNamesFromDataframe( "DR1T", fdata ) ]='diet'
# colcats[ colnames(fdata) %in%  getNamesFromDataframe( "cfd", fdata )[-1] ]='digitspan'
tbl=table(colcats)
##############
nh_list=list()
knm=names(tbl)[-1]
mycc = complete.cases( fdata[ , colcats %in% 'demog' ])
mycc = complete.cases( fdata[ , colcats %in% 'exposures' ])
table(mycc)
doimp=TRUE
for ( k in knm ) {
    print(k)
    if ( doimp ) {
      temp0 = impute_data( fdata[ ,colcats==k] )
    } else temp0=(fdata[mycc,colcats==k])
    temp = data.frame(convert_to_numeric_matrix( temp0 ))
    vv=apply( temp, 2, FUN=var )
    temp = temp[ , vv > 0 ]
    if ( k %in% c('exposures','diet') ) {
      nn = colnames(temp)
      for (  jj in 1:ncol(temp) ) temp = truncatehi(temp, nn[jj], t = 10, removeit = FALSE)
#      temp = robustMatrixTransform( temp )
      colnames(temp) = nn
      temp = remove_perfectly_correlated( temp )
    }
    for ( j in 1:ncol(temp) ) {
        hist( temp[,j], main=colnames(temp)[j])
#        Sys.sleep(1)
        }
    nh_list[[length(nh_list)+1]]=data.matrix( ( temp ) )
    print(colnames(nh_list[[length(nh_list)]]))
#    nh_list[[length(nh_list)]]=impute_and_report_na(nh_list[[length(nh_list)]] )
    }
names(nh_list)=knm
#####

```

Run the methods using reasonable defaults as recommended by prior work.

```{r nhanessimlrrun,eval=TRUE}
################################################################################
# regs <- regularizeSimlr(nh_list,fraction=0.15,sigma=rep(1.0,length(nh_list)))
#
regs=list()
wdemog=which( knm == 'demog')
for ( wdemog in 1:length(nh_list) ) regs[[ wdemog]]=diag( ncol(nh_list[[wdemog]]))
# regs = regularizeSimlr(nh_list)
names( regs ) = knm[ -1 ]
initu=initializeSimlr( nh_list, k=round(max_columns_list(nh_list)), jointReduction=TRUE )
###########################
if ( ! exists("resultNH") ) {
  resultNH <- simlr( nh_list, 
        iterations=100,
        sparsenessQuantiles=rep(0.5,length(nh_list)),
        positivities=rep("positive",length(nh_list)), 
        energyType='regression', mixAlg='ica',
#        energyType='cca', mixAlg='pca',
        scale=c("centerAndScale",  "np"),
#        scale=c("whiten", "np"),
        constraint="Stiefelx10x10",
        randomSeed=99,
        initialUMatrix=initu, verbose=T )
  }
#####################################################
```

Apply the learned representations to the data matrices.

```{r nhanessimlrstat,eval=TRUE}
# drwwrd
projlist=list()
mysimk=ncol(initu)
for ( k in 2:length(nh_list)) {
    rownames(resultNH$v[[k]])=colnames( nh_list[[k]])
    ux=data.frame(nh_list[[k]] %*% abs(resultNH$v[[k]][,1:mysimk]))
    colnames(ux)=paste0(names(nh_list)[k],1:ncol(ux))
    projlist[[length(projlist)+1]]=ux
    names( projlist )[length(projlist)]=knm[k]
}
simdf=simdf2=dplyr::bind_cols(projlist)
cognames = c(
  "z_cerad_re", "z_animal_re",      "z_delayed_re",    "z_global_re",     "z_digit_re"
#  "z_cerad_age", "z_animal_age",     "z_digit_age",      "z_delayed_age",    "z_global_age",
#  "z_cerad_edu", "z_animal_edu",     "z_digit_edu",      "z_delayed_edu",    "z_global_edu"
)
# cognames=c("cerad_sum","cfdast","cfdds")
dnames = c( "riagendr", "ridageyr", "race", "dmdeduc2", "INDFMPIR",'wtint2yr','wtmec2yr')
if ( doimp ) {
  simdf2[,dnames]=fdata[,dnames]
  simdf2[,cognames]=fdata[,cognames]
  } else {
  simdf2[,dnames]=fdata[mycc,dnames]
  simdf2[,cognames]=fdata[mycc,cognames]
  }
#################################
covars=" ~ riagendr + ridageyr + race + dmdeduc2 + INDFMPIR + "
covars=" ~ riagendr + ridageyr + dmdeduc2 + INDFMPIR + " # race adjusted scores
basep=0.01
basep=1e-8
# rooter
if ( ! exists("cogind" ) ) cogind = length(cognames)
#############################
for ( kk in 1:ncol(initu)) {
  bform = paste0( cognames[cogind], covars, "1" )
  myform = paste0( cognames[cogind], covars,paste0( paste0(names(projlist),kk), collapse='+'))
  if ( basep >= 0.001 ) tempdf = simdf2[mycc,] else tempdf = simdf2[,]
  bmdl = lm( bform, data=tempdf )
  mdl = lm( myform, data=tempdf )
#  if (doimp) mdl = lm( myform, data=tempdf, weights=tempdf$wtint2yr ) else mdl = lm( myform, data=tempdf, weights=tempdf$wtint2yr  )
  myanv = anova( bmdl, mdl )
  if ( myanv$Pr[2] < basep/mysimk ) {
    cat("*** result begin ***********************************\n")
    print("individual coefficients")
    tailcoffs = tail( coefficients( summary( mdl ) ), 4 )
    print( tailcoffs )
    print( paste("multivar-ANOVA p-value", insight::format_p(myanv$Pr[2],digits=4) ) )
    print( cognames[cogind])
    for ( k in names(projlist) ) {
      print( paste("Simlr weights", k ) )
      print( interpret_simlr_vector2( resultNH$v[[k]], kk, n2show=3, shortnames=F ) )
      ttl = paste0(k,kk, " ", insight::format_p(tailcoffs[paste0(k,kk),"Pr(>|t|)"],digits=4)  )
      visreg::visreg(mdl, paste0(k,kk), main=ttl )
      }
    cat("*** result end ***********************************\n\n")
#    Sys.sleep(3)
  }
}
##########################################################################################
##########################################################################################
# https://wwwn.cdc.gov/nchs/nhanes/search/default.aspx
# > interpret_simlr_vector2( resultNH$v[['exposures']], 1, n2show=5, shortnames=F )
#   LBXVBZ    LBXVOX    LBXVFN    LBX2DF 
# benzene, Xylene, furan, Dimethylfuran
# 1.0000000 0.3346728 0.1868323 0.0586727 
##########################################################################################
```



```{r hold,echo=FALSE,eval=FALSE}
for ( kk in 1:length(cognames)) {
    myform = paste0( cognames[kk], covars,paste0( colnames(simdf), collapse='+'))
    tempdf = simdf2[mycc,]
    mdl = lm( myform, data=tempdf )
  #  if (doimp) mdl = lm( myform, data=tempdf, weights=tempdf$wtint2yr ) else mdl = lm( myform, data=tempdf, weights=tempdf$wtint2yr  )
    print( summary( mdl ) )
    print( cognames[kk])
    Sys.sleep(3)
  }
```